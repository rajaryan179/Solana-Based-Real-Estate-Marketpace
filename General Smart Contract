use anchor_lang::prelude::*;
use anchor_spl::token::{self, Token, TokenAccount};

declare_id!("YOUR_PROGRAM_ID_HERE");

#[program]
mod real_estate_marketplace {
    use super::*;

    pub fn initialize_property(ctx: Context<InitializeProperty>, price: u64, description: String) -> Result<()> {
        let property = &mut ctx.accounts.property;
        property.price = price;
        property.description = description;
        property.owner = *ctx.accounts.owner.key;
        Ok(())
    }

    pub fn buy_property(ctx: Context<BuyProperty>) -> Result<()> {
        let property = &mut ctx.accounts.property;
        let buyer = &ctx.accounts.buyer;
        let seller = &ctx.accounts.seller;

        // Transfer ownership
        property.owner = *buyer.key;

        // Transfer tokens
        let cpi_accounts = token::Transfer {
            from: ctx.accounts.buyer_token_account.to_account_info(),
            to: ctx.accounts.seller_token_account.to_account_info(),
            authority: buyer.to_account_info(),
        };
        let cpi_program = ctx.accounts.token_program.to_account_info();
        let cpi_context = CpiContext::new(cpi_program, cpi_accounts);
        token::transfer(cpi_context, property.price)?;

        Ok(())
    }
}

#[derive(Accounts)]
pub struct InitializeProperty<'info> {
    #[account(init, payer = owner, space = 8 + 32 + 8 + 200)]
    pub property: Account<'info, Property>,
    #[account(mut)]
    pub owner: Signer<'info>,
    pub system_program: Program<'info, System>,
}

#[derive(Accounts)]
pub struct BuyProperty<'info> {
    #[account(mut, has_one = owner)]
    pub property: Account<'info, Property>,
    #[account(mut)]
    pub buyer: Signer<'info>,
    #[account(mut)]
    pub seller: Signer<'info>,
    #[account(mut, "buyer_token_account.owner == *buyer.key")]
    pub buyer_token_account: Account<'info, TokenAccount>,
    #[account(mut, "seller_token_account.owner == *seller.key")]
    pub seller_token_account: Account<'info, TokenAccount>,
    pub token_program: Program<'info, Token>,
}

#[account]
pub struct Property {
    pub owner: Pubkey,
    pub price: u64,
    pub description: String,
}
